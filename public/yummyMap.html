<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ½ï¸ Yummy Map</title>
    <script src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpClientId=87ni0cgqze&submodules=geocoder"></script>
    <style>
        /* ì „ì²´ ë°°ê²½ì„ ë…¸ë€ìƒ‰ìœ¼ë¡œ ì„¤ì • */
        body {
            background-color: #FFF8DC; /* ë¶€ë“œëŸ¬ìš´ ë…¸ë€ìƒ‰ */
            font-family: "Comic Sans MS", "Arial", sans-serif; /* ê·€ì—¬ìš´ í°íŠ¸ */
            text-align: center;
            padding: 20px;
        }

        /* íƒ€ì´í‹€ ìŠ¤íƒ€ì¼ */
        h1, h2 {
            color: #FF8C00; /* ì˜¤ë Œì§€ìƒ‰ */
        }

        /* ì§€ë„ ìŠ¤íƒ€ì¼ */
        #map {
            width: 90%;
            height: 500px;
            margin: 10px auto;
            border-radius: 15px;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
        }

        /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ */
        input[type="text"] {
            width: 80%;
            max-width: 400px;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #FFA500; /* ì˜¤ë Œì§€ í…Œë‘ë¦¬ */
            border-radius: 20px;
            outline: none;
            text-align: center;
            background-color: #FFFAF0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        input[type="button"] {
            margin-top: 10px;
            padding: 10px 20px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #FF8C00; /* ë°ì€ ì˜¤ë Œì§€ */
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        input[type="button"]:hover {
            background-color: #FF4500; /* ë” ì§„í•œ ì˜¤ë Œì§€ */
            transform: scale(1.05);
        }

        /* ë“±ë¡ ì •ë³´ ë°•ìŠ¤ */
        #markerInfo {
            margin-top: 15px;
            padding: 10px;
            font-size: 14px;
            background-color: #FFECB3;
            border-radius: 10px;
            display: inline-block;
            box-shadow: 0px 2px 5px rgba(0, 0, 0, 0.1);
        }

         /* ğŸ“œ ì¢…ì´ ëª¨ì–‘ ë²„íŠ¼ - ì™¼ìª½ ìƒë‹¨ */
        #store-list-container {
            position: fixed;
            top: 15px;
            left: 15px;
            width: 250px;
            height: auto;
            z-index: 1000;
        }

        /* ğŸ“œ ì¢…ì´ ë§ë¦° íš¨ê³¼ */
        #store-list-toggle {
            width: 50px;
            height: 50px;
            background-color: #fff;
            border-radius: 50%;
            text-align: center;
            line-height: 50px;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 3px 3px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease-in-out;
            position: relative;
        }

        #store-list-toggle:hover {
            transform: rotate(-10deg);
        }

        /* ğŸ“œ ì¢…ì´ ë§ë¦° ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        #store-list {
            display: none;
            background: white;
            width: 100%;
            max-height: 300px;
            overflow: hidden; /* ë¶€ëª¨ ìš”ì†Œì—ì„œ ìŠ¤í¬ë¡¤ì„ ê°ì¶¤ */
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 2px solid #ddd;
            transform: rotateX(90deg);
            transform-origin: top;
            transition: transform 0.5s ease-in-out;
            position: absolute;
            top: 60px;
            left: 0;
        }

        /* í¼ì³ì§ˆ ë•Œ */
        #store-list.active {
            display: block;
            transform: rotateX(0deg);
        }

        /* ë¦¬ìŠ¤íŠ¸ ë‚´ë¶€ ìŠ¤í¬ë¡¤ */
        #store-items {
            list-style: none;
            padding: 0;
            max-height: 230px;
            overflow-y: auto;
            padding-right: 5px; /* ìŠ¤í¬ë¡¤ë°” ê²¹ì¹˜ì§€ ì•Šê²Œ */
        }

        /* ìŠ¤í¬ë¡¤ë°” ë””ìì¸ */
        #store-items::-webkit-scrollbar {
            width: 8px;
        }

        #store-items::-webkit-scrollbar-thumb {
            background: #FFA500; /* ìŠ¤í¬ë¡¤ë°” ìƒ‰ìƒ */
            border-radius: 4px;
        }

        #store-items::-webkit-scrollbar-track {
            background: #FFFAF0; /* ìŠ¤í¬ë¡¤ë°” íŠ¸ë™ ë°°ê²½ */
        }

        /* ë¦¬ìŠ¤íŠ¸ ì•„ì´í…œ ë””ìì¸ */
        #store-items li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            background: #FFFAF0;
            margin: 5px 0;
            border-radius: 10px;
            font-size: 14px;
            text-align: center;
            font-family: "Comic Sans MS", cursive, sans-serif;
        }

        #store-items li:last-child {
            border-bottom: none;
        }
        /* ğŸ” ê²€ìƒ‰ì°½ ìŠ¤íƒ€ì¼ */
        .search-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        #searchInput {
            width: 80%;
            max-width: 400px;
            padding: 10px;
            font-size: 16px;
            border: 2px solid #FFA500;
            border-radius: 20px;
            outline: none;
            text-align: center;
            background-color: #FFFAF0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .search-button {
            padding: 10px 15px;
            font-size: 16px;
            font-weight: bold;
            color: white;
            background-color: #FF8C00;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }

        .search-button:hover {
            background-color: #FF4500;
            transform: scale(1.05);
        }
        /* ğŸ€ ëœë¤ ì¶”ì²œ ë²„íŠ¼ */
        .random-button {
        background-color: #FF8C00;
        color: white;
        font-size: 18px;
        font-weight: bold;
        padding: 15px 30px;
        border-radius: 25px;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease-in-out;
        box-shadow: 2px 4px 8px rgba(0, 0, 0, 0.3);
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        outline: none;
        }

        .random-button:hover {
            background-color: #FF4500;
            transform: scale(1.1);
        }

        /* ğŸ‰ ì¶”ì²œ ì• ë‹ˆë©”ì´ì…˜ */
        #recommendation {
            display: none;
            font-size: 24px;
            font-weight: bold;
            color: #FF8C00;
            background: white;
            padding: 10px 20px;
            border-radius: 20px;
            box-shadow: 3px 3px 10px rgba(0, 0, 0, 0.2);
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            animation: bounce 1s infinite;
        }

        /* ë§í’ì„  íš¨ê³¼ */
        @keyframes bounce {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }

        .naver-map-marker {
            pointer-events: auto !important; /*IOS í´ë¦­ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ì • */
            z-index: 1000 !important;
        }
   
    </style>
</head>
<body>
    <div class="search-container">
        <input type="text" id="searchInput" placeholder="ğŸ” ê²€ìƒ‰í•  ê°€ê²Œëª…ì„ ì…ë ¥í•˜ì„¸ìš”!" >
        <button class="search-button" onclick="filterStoreList()">ê²€ìƒ‰</button>
    </div>

   <h1>ğŸ½ï¸ ì˜¤ëŠ˜ ë­ ë¨¹ì§€?</h1> 
   <!-- <div style="display: flex; align-items: center; gap: 10px; justify-content: center; text-align: center; margin: 0 auto;">
        <img src="/alba.png" alt="ì œë¡œí˜ì´ ê°€ë§¹ì " style="height: 50px;">
        <h2 style="margin: 0;"></h2>
    </div> -->

    <div id="store-list-container">
        <div id="store-list-toggle" onclick="toggleStoreList()">ğŸ“œ</div>
        <div id="store-list">
            <h3>ğŸ“Œ ë§›ì§‘ ë¦¬ìŠ¤íŠ¸</h3>
            <ul id="store-items"></ul>
        </div>
    </div>

    <button class="random-button" onclick="recommendRandomStore()">ğŸ€ ëœë¤ ì¶”ì²œ</button>
    <button class="random-button reset-button" onclick="resetMap()">ğŸ”„ ë§µ ì´ˆê¸°í™”</button>

    <div id="recommendation"></div>

   <div id="map"></div>

   <br>

   <input type="text" id="storeName" placeholder="ğŸ ì˜ˆ: íŒŒë¦¬ë°”ê²ŒíŠ¸">
   <br><br>
   <input type="text" id="storeAddress" placeholder="ğŸ“ ì„œìš¸ ê°•ë‚¨êµ¬ í…Œí—¤ë€ë¡œ 326 I-TOWER">
   <br><br>
   <input type="button" value="ğŸ¥³ ìŒì‹ì  ë“±ë¡" onclick="GetGeocode()">

   <!-- <div id="markerInfo">ğŸ“ ë§ˆì»¤ë¥¼ ì´ë™í•˜ë©´ ì¢Œí‘œê°€ í‘œì‹œë©ë‹ˆë‹¤.</div> -->

   <script type="text/javascript">
    var zeroPayStores = [{ name: "ì•Œë°”ì²œêµ­", lat: 37.5032355765545, lng: 127.046582379785, type: "company" }];
    let zeroPayMarkers = [];
    let map;

    window.onload = SetStores;

    function SetMap() {

        map = new naver.maps.Map('map', {
            center: new naver.maps.LatLng(37.5045028775835, 127.048942471228),
            zoom: 17
        });

       var storeIcon = "https://cdn-icons-png.flaticon.com/128/3170/3170733.png"; // ìŒì‹ì  ì•„ì´ì½˜
       var companyIcon = "public/alba.png"; // íšŒì‚¬ ì•„ì´ì½˜

       var referenceStore = zeroPayStores.find(store => store.name === "ì•Œë°”ì²œêµ­");

       zeroPayStores.forEach(function(store) {
            var iconUrl = (store.type === "company") ? companyIcon : storeIcon;

            var marker = new naver.maps.Marker({
                position: new naver.maps.LatLng(store.lat, store.lng),
                map: map,
                icon: {
                    url: iconUrl,
                    size: new naver.maps.Size(30, 30),
                    scaledSize: new naver.maps.Size(30, 30),
                    origin: new naver.maps.Point(0, 0),
                    anchor: new naver.maps.Point(20, 40)
                },
                draggable: true
            });

            // var infowindow = new naver.maps.InfoWindow({
            //     content: `<div style="padding:5px;">${store.name}</div>`
            // });
            zeroPayMarkers.push({ storeName: store.name, marker: marker });
            var naverMapLink = `https://map.naver.com/v5/search/${store.name}?c=${store.lng},${store.lat},17,0,0,0,dh`;
            
            // ê°€ê²Œ íƒ€ì…ë³„ ì´ëª¨ì§€ ì„¤ì • (ê·€ì—¬ìš´ ìš”ì†Œ ì¶”ê°€)
            var emoji = "ğŸ½ï¸"; // ê¸°ë³¸ ìŒì‹ì 
            if (store.name.includes("ì»¤í”¼") || store.name.includes("ì¹´í˜") || store.name.includes("ìŠ¤íƒ€ë²…ìŠ¤")) {
                emoji = "â˜•";
            } else if (store.name.includes("ì¹˜í‚¨") || store.name.includes("BBQ")) {
                emoji = "ğŸ—";
            } else if (store.name.includes("í–„ë²„ê±°") || store.name.includes("ë²„ê±°")|| store.name.includes("ë§˜ìŠ¤í„°ì¹˜")) {
                emoji = "ğŸ”";
            } else if (store.type === "company") {
                emoji = "ğŸ¢"; // íšŒì‚¬ ì•„ì´ì½˜
            }

        

            // ê·€ì—¬ìš´ ë””ìì¸ì´ ì ìš©ëœ InfoWindow
            var infowindow = new naver.maps.InfoWindow({
            content: `
                <div style="
                    padding: 10px; 
                    border-radius: 10px; 
                    background-color: #FFF8DC; 
                    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2); 
                    text-align: center;
                    font-family: 'Comic Sans MS', sans-serif;
                    max-width: 200px;
                ">
                    <div style="font-size: 18px; font-weight: bold; margin-bottom: 5px;">
                        ${emoji} ${store.name}
                    </div>
                    <div id="walking-time-${store.name}" style="font-size: 14px; color: #555;"></div>
                    <a href="https://map.naver.com/v5/search/${store.name}?c=${store.lng},${store.lat},17,0,0,0,dh" target="_blank" style="
                        display: inline-block;
                        padding: 5px 10px;
                        font-size: 14px;
                        color: white;
                        background-color: #FF8C00;
                        border-radius: 5px;
                        text-decoration: none;
                        font-weight: bold;
                    ">ğŸ—ºï¸ ë„¤ì´ë²„ ì§€ë„ì—ì„œ ë³´ê¸°</a>
                </div>`
           });

            naver.maps.Event.addListener(marker, "dragend", function(e) {
                if(confirm("ìœ„ì¹˜ë¥¼ ìˆ˜ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?") == true){
                    var lat = e.coord.y;
                    var lng = e.coord.x;
                    //document.getElementById("markerInfo").innerHTML = `ğŸ“ ${store.name} ì´ë™ë¨:<br> ìœ„ë„: ${lat}<br> ê²½ë„: ${lng}`;
                    var store_json = { name: store.name, lat: lat, lng: lng, type: "store" };

                    updatecoords(store_json);
                }
            });

            naver.maps.Event.addListener(marker, "click", function() {
                if (infowindow.getMap()) {
                    infowindow.close();
                } else {
                    infowindow.open(map, marker);

                     // ğŸ“ ê¸°ì¤€ ë§ˆì»¤ì™€ì˜ ë„ë³´ ì´ë™ ì‹œê°„ ê³„ì‚°
                    if (referenceStore) {
                        var distance = getDistance(store.lat, store.lng, referenceStore.lat, referenceStore.lng);
                        var walkingTime = getWalkingTime(distance);
                        document.getElementById(`walking-time-${store.name}`).innerHTML = `ğŸš¶â€â™‚ï¸ ë„ë³´ ì‹œê°„: <b>${walkingTime}ë¶„</b>`;
                    }
                }
            });
        });
    }

    function GetGeocode() {
        var address = document.getElementById("storeAddress").value;
        var name = document.getElementById("storeName").value;

        if (!address || !name) {
            alert("ğŸ• ìŒì‹ì ëª…ê³¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        naver.maps.Service.geocode({ address: address }, function(status, response) {
            if (status !== naver.maps.Service.Status.OK) {
                alert("ì£¼ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            var firstItem = response.result.items[0];
            var lat = firstItem.point.y;
            var lng = firstItem.point.x;
            var address = firstItem.address;

            if(!!lat && !!lng && !!address){
                var addjson = { name: name,address:address, lat: lat, lng: lng, type: "store" };
                addStore(addjson);
            }else{
                alert('ìƒì ì„ ë“±ë¡ í• ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
        });
    }

    //ğŸ“ ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜ (Haversine Formula)
    function getDistance(lat1, lon1, lat2, lon2) {
        const R = 6371; // ì§€êµ¬ ë°˜ì§€ë¦„ (km)
        const dLat = (lat2 - lat1) * (Math.PI / 180);
        const dLon = (lon2 - lon1) * (Math.PI / 180);
        const a =   Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * (Math.PI / 180)) * Math.cos(lat2 * (Math.PI / 180)) *
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return (R * c).toFixed(2); // km ë‹¨ìœ„ ê±°ë¦¬ ë°˜í™˜ (ì†Œìˆ˜ì  2ìë¦¬)
    }

    // ğŸš¶â€â™‚ï¸ ë„ë³´ ì´ë™ ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
    function getWalkingTime(distanceKm) {
        const walkingSpeedKmPerHour = 3.5; // í‰ê·  ë„ë³´ ì†ë„ (4.8 km/h)
        const timeMinutes = (distanceKm / walkingSpeedKmPerHour) * 60;
        return Math.ceil(timeMinutes); // ì†Œìˆ˜ì  ì˜¬ë¦¼ (ì •ìˆ˜ê°’ ë°˜í™˜)
    }

    async function SetStores() 
    {
        zeroPayStores = [{ name: "ì•Œë°”ì²œêµ­", lat: 37.5032355765545, lng: 127.046582379785, type: "company" }];

        try {
            const response = await fetch('/store/all');
            const stores = await response.json();

            stores.forEach(store => {
                zeroPayStores.push({
                    name: store.name,
                    lat: store.lat,
                    lng: store.lng,
                    type: store.type
                });
            });

            if(zeroPayStores.length <=0){
                alert("ë“±ë¡ëœ ê°€ê²Œê°€ ì—†ìŠµë‹ˆë‹¤.");
            }
            
            StoreList(zeroPayStores);
            SetMap();

        } catch (error) {
            console.error('Error fetching store data:', error);
        }
    }

    async function addStore(store)
    {
        try {
        
            const response = await fetch("/store/add", {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify(store),
                                });

            const result = await response.json();

            if(!!result){
                alert("ğŸ• ìŒì‹ì ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                SetStores();
            }

        } catch (error) {
            console.error('Error adding store:', error);
        }
    }


    async function updatecoords(store)
    {
        try {
        
            const response = await fetch("/store/update", {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify(store),
                                });

            const result = await response.json();

            if(!!result){
                alert("ğŸ• ìœ„ì¹˜ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                SetStores();
            }

        } catch (error) {
            console.error('Error updating store:', error);
        }
    }

    async function StoreList(zeroPayStores) {
       
        const storeList = document.getElementById('store-items');
        storeList.innerHTML = '';

        zeroPayStores.forEach((store) => {

            if(store.type === "company") return;

            const listItem = document.createElement('li');
            listItem.textContent = `${store.name}`;

            
            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            listItem.addEventListener('click', function() {
                const markerData = zeroPayMarkers.find(item => item.storeName === store.name);
                if (markerData) {
                    naver.maps.Event.trigger(markerData.marker, 'click');
                }
            });

            storeList.appendChild(listItem);
        });
    }

    // í† ê¸€ ê¸°ëŠ¥
    function toggleStoreList() {
        const storeList = document.getElementById('store-list');
        storeList.classList.toggle('active');
    }

   function recommendRandomStore() {
        let storeNames = zeroPayStores.filter(store => store.type !== 'company');
        if (storeNames.length === 0) {
            alert("ë“±ë¡ëœ ë§›ì§‘ì´ ì—†ìŠµë‹ˆë‹¤!");
            return;
        }

        let randomIndex = Math.floor(Math.random() * storeNames.length);
        let winningStore = storeNames[randomIndex];

        let recommendationDiv = document.getElementById("recommendation");
        recommendationDiv.innerHTML = `ğŸ‰ ${winningStore.name}!`;
        recommendationDiv.style.display = "block";

        setTimeout(() => {
            recommendationDiv.style.display = "none";
        }, 3000);

        let winningMarker = zeroPayMarkers.find(item => item.storeName === winningStore.name);
        if (winningMarker) {
            naver.maps.Event.trigger(winningMarker.marker, 'click');
            map.setZoom(18);
            map.setCenter(winningMarker.marker.getPosition());
        }
    }

    function resetMap() {
        map.setCenter(new naver.maps.LatLng(37.5045, 127.0489));
        map.setZoom(17);
    }

    function filterStoreList() {
        alet('ì¤€ë¹„ì¤‘ ì…ë‹ˆë‹¤');
        return;       
    }

    </script>
  
</body>
</html>
